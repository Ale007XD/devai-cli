name: ðŸš€ Auto Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” SSH to VPS & Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            mkdir -p /app/bot
            cd /app/bot
            
            # Pull ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´
            git fetch origin
            git reset --hard origin/main
            
            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ð¸Ð· GitHub Secrets (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾!)
            cat > .env << EOF
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            ADMIN_ID=${{ secrets.ADMIN_ID }}
            SENTRY_DSN=${{ secrets.SENTRY_DSN }}
            EOF
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Docker)
            pip install -r requirements.txt --user
            
            # Graceful restart Docker
            docker-compose down || true
            docker-compose up -d --build --remove-orphans
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
            docker-compose ps
            docker-compose logs --tail=20 bot
            
            echo "âœ… Deploy completed!"
