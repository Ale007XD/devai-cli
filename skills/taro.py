from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

router = Router()

# --- –ö–æ–Ω—Ç–µ–Ω—Ç –∫—É—Ä—Å–∞ (–ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω) ---
COURSE_DATA = {
    "intro": {
        "title": "üë∂ –í–≤–µ–¥–µ–Ω–∏–µ (–£—Ä–æ–∫–∏ 1-6)",
        "lessons": [
            "üìú **–£—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–∏–µ –≤ –¢–∞—Ä–æ**\n\n–¢–∞—Ä–æ ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è. –ö–æ–ª–æ–¥–∞ –†–∞–π–¥–µ—Ä–∞-–£–∞–π—Ç–∞ (1910) ‚Äî —ç—Ç–∞–ª–æ–Ω–Ω–∞—è.\n\n**–ó–∞–¥–∞–Ω–∏–µ:** –ö—É–ø–∏—Ç–µ –∫–æ–ª–æ–¥—É –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–¥–µ—Ä–∂–∏—Ç–µ –∫–∞—Ä—Ç—ã –≤ —Ä—É–∫–∞—Ö.",
            "üÉè **–£—Ä–æ–∫ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–æ–¥—ã**\n\n–í—Å–µ–≥–æ 78 –∫–∞—Ä—Ç:\n‚Ä¢ **22 –°—Ç–∞—Ä—à–∏—Ö –ê—Ä–∫–∞–Ω–∞**: –í–µ–ª–∏–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã, –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏.\n‚Ä¢ **56 –ú–ª–∞–¥—à–∏—Ö –ê—Ä–∫–∞–Ω–æ–≤**: –ë—ã—Ç–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (–ñ–µ–∑–ª—ã, –ö—É–±–∫–∏, –ú–µ—á–∏, –ü–µ–Ω—Ç–∞–∫–ª–∏).",
            "üé® **–£—Ä–æ–∫ 3: –°–∏–º–≤–æ–ª–∏–∫–∞**\n\n–¶–≤–µ—Ç–∞:\n‚Ä¢ –ñ–µ–ª—Ç—ã–π ‚Äî —ç–Ω–µ—Ä–≥–∏—è, —Ä–∞–∑—É–º.\n‚Ä¢ –°–∏–Ω–∏–π ‚Äî –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, —ç–º–æ—Ü–∏–∏.\n‚Ä¢ –ö—Ä–∞—Å–Ω—ã–π ‚Äî —Å—Ç—Ä–∞—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ.\n\n–û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–∑—ã –≥–µ—Ä–æ–µ–≤ –∏ —Ñ–æ–Ω.",
            "üõ°Ô∏è **–£—Ä–æ–∫ 4: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**\n\n1. –û—á–∏—Å—Ç–∏—Ç–µ –º–µ—Å—Ç–æ (—É–±–µ—Ä–∏—Ç–µ –ª–∏—à–Ω–µ–µ).\n2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ—Å—å (–º–µ–¥–∏—Ç–∞—Ü–∏—è 2 –º–∏–Ω).\n3. –ü–µ—Ä–µ—Ç–∞—Å—É–π—Ç–µ –∫–æ–ª–æ–¥—É, –¥—É–º–∞—è –æ –≤–æ–ø—Ä–æ—Å–µ.",
            "üìñ **–£—Ä–æ–∫ 5: –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏**\n\n–ù–µ –∑—É–±—Ä–∏—Ç—å! –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É. –ß—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? –≠—Ç–æ –≤–∞–∂–Ω–µ–µ –∫–Ω–∏–∂–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Ç–≤–µ—Ç.",
            "üß© **–£—Ä–æ–∫ 6: –ü—Ä–∞–∫—Ç–∏–∫–∞ '–ö–∞—Ä—Ç–∞ –¥–Ω—è'**\n\n–£—Ç—Ä–æ–º –≤—ã—Ç—è–Ω–∏—Ç–µ 1 –∫–∞—Ä—Ç—É. –ó–∞–ø–∏—à–∏—Ç–µ –º—ã—Å–ª–∏. –í–µ—á–µ—Ä–æ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å –ø—Ä–æ—à–µ–¥—à–∏–º –¥–Ω–µ–º.\n**–î–ó:** –î–µ–ª–∞—Ç—å —ç—Ç–æ 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥."
        ]
    },
    "minor_courts": {
        "title": "ü§¥ –ü—Ä–∏–¥–≤–æ—Ä–Ω—ã–µ –∫–∞—Ä—Ç—ã (–£—Ä–æ–∫–∏ 7-10)",
        "lessons": [
            "üî• **–£—Ä–æ–∫ 7: –ö–æ—Ä–æ–ª–∏ –∏ –†—ã—Ü–∞—Ä–∏ (–ú–∞—Å—Ç–µ—Ä–∞)**\n\n‚Ä¢ **–ñ–µ–∑–ª—ã:** –õ–∏–¥–µ—Ä, —ç–Ω—Ç—É–∑–∏–∞—Å—Ç / –ê–∫—Ç–∏–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.\n‚Ä¢ **–ö—É–±–∫–∏:** –≠–º–ø–∞—Ç, –ø—Å–∏—Ö–æ–ª–æ–≥ / –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∂–µ—Å—Ç.\n‚Ä¢ **–ú–µ—á–∏:** –ê–Ω–∞–ª–∏—Ç–∏–∫, —Å—É–¥—å—è / –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Å–ø–æ—Ä.\n‚Ä¢ **–ü–µ–Ω—Ç–∞–∫–ª–∏:** –ë–∏–∑–Ω–µ—Å–º–µ–Ω, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å / –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.",
            "üë∂ **–£—Ä–æ–∫ 8: –ü–∞–∂–∏ (–í–µ—Å—Ç–Ω–∏–∫–∏)**\n\n‚Ä¢ **–ñ–µ–∑–ª—ã:** –ù–æ–≤–∞—è –∏–¥–µ—è, –∏—Å–∫—Ä–∞.\n‚Ä¢ **–ö—É–±–∫–∏:** –ù–æ–≤–æ—Å—Ç—å –æ —á—É–≤—Å—Ç–≤–∞—Ö, –ø—Ä–∏–º–∏—Ä–µ–Ω–∏–µ.\n‚Ä¢ **–ú–µ—á–∏:** –®–ø–∏–æ–Ω–∞–∂, —Å–ø–ª–µ—Ç–Ω–∏, –∫—Ä–∏—Ç–∏–∫–∞.\n‚Ä¢ **–ü–µ–Ω—Ç–∞–∫–ª–∏:** –£—á–µ–±–∞, –Ω–µ–±–æ–ª—å—à–∞—è –ø—Ä–∏–±—ã–ª—å.",
            "üé≠ **–£—Ä–æ–∫ 9: –†–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã**\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞–∫–æ–º—ã—Ö –≤ —Ä–æ–ª—è—Ö –ü–∞–∂–µ–π –∏–ª–∏ –ö–æ—Ä–æ–ª–µ–π. –ö—Ç–æ –≤–∞—à –Ω–∞—á–∞–ª—å–Ω–∏–∫? –ö—Ç–æ –¥—Ä—É–≥?\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–ø–æ–º–Ω–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä—ã.",
            "üÉè **–£—Ä–æ–∫ 10: –†–∞—Å–∫–ª–∞–¥ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å**\n\n–í—ã—Ç—è–Ω–∏—Ç–µ 1 –∫–∞—Ä—Ç—É –Ω–∞ –≤–æ–ø—Ä–æ—Å: '–ö–∞–∫ –º–µ–Ω—è –≤–∏–¥—è—Ç –æ–∫—Ä—É–∂–∞—é—â–∏–µ?'. –ï—Å–ª–∏ –≤—ã–ø–∞–ª –ü–∞–∂ ‚Äî –≤—ã –∫–∞–∂–µ—Ç–µ—Å—å –º–æ–ª–æ–¥—ã–º/–Ω–µ–æ–ø—ã—Ç–Ω—ã–º. –ö–æ—Ä–æ–ª—å ‚Äî –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º."
        ]
    },
    "minor_pips": {
        "title": "üî¢ –ß–∏—Å–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (–£—Ä–æ–∫–∏ 11-14)",
        "lessons": [
            "1Ô∏è‚É£ **–£—Ä–æ–∫ 11: –¢—É–∑—ã –∏ –î–≤–æ–π–∫–∏**\n\n‚Ä¢ **–¢—É–∑—ã:** –®–∞–Ω—Å, –Ω–∞—á–∞–ª–æ, –∏–º–ø—É–ª—å—Å.\n‚Ä¢ **–î–≤–æ–π–∫–∏:** –í—ã–±–æ—Ä, –±–∞–ª–∞–Ω—Å, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ (–∏–ª–∏ —Å–æ–º–Ω–µ–Ω–∏—è).",
            "3Ô∏è‚É£ **–£—Ä–æ–∫ 12: –¢—Ä–æ–π–∫–∏ - –°–µ–º–µ—Ä–∫–∏**\n\n‚Ä¢ **3:** –†–æ—Å—Ç, –ø—Ä–∞–∑–¥–Ω–∏–∫.\n‚Ä¢ **4:** –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–∏–Ω–æ–≥–¥–∞ –∑–∞—Å—Ç–æ–π).\n‚Ä¢ **5:** –ö—Ä–∏–∑–∏—Å, –ø–æ—Ç–µ—Ä—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç.\n‚Ä¢ **6:** –ü–æ–º–æ—â—å, –Ω–æ—Å—Ç–∞–ª—å–≥–∏—è, –ø–æ–±–µ–¥–∞.\n‚Ä¢ **7:** –¢–µ—Ä–ø–µ–Ω–∏–µ, —Ö–∏—Ç—Ä–æ—Å—Ç—å, –∏–ª–ª—é–∑–∏–∏.",
            "8Ô∏è‚É£ **–£—Ä–æ–∫ 13: –í–æ—Å—å–º–µ—Ä–∫–∏ - –î–µ—Å—è—Ç–∫–∏**\n\n‚Ä¢ **8:** –î–≤–∏–∂–µ–Ω–∏–µ –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.\n‚Ä¢ **9:** –û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –∏–ª–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ.\n‚Ä¢ **10:** –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞ (–º–∞–∫—Å–∏–º—É–º –º–∞—Å—Ç–∏).",
            "üÉè **–£—Ä–æ–∫ 14: –ü—Ä–∞–∫—Ç–∏–∫–∞ '–°–∏—Ç—É–∞—Ü–∏—è'**\n\n–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å: '–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –º–æ–µ–π —Ä–∞–±–æ—Ç–µ?'. –í—ã—Ç—è–Ω–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–≤—è–∑–∞—Ç—å –∏—Ö –≤ –∏—Å—Ç–æ—Ä–∏—é."
        ]
    },
    "royals": {
        "title": "üëë –ö–æ—Ä–æ–ª–µ–≤—ã (–£—Ä–æ–∫–∏ 15-16)",
        "lessons": [
            "üë∏ **–£—Ä–æ–∫ 15: –ö–æ—Ä–æ–ª–µ–≤—ã**\n\n‚Ä¢ **–ñ–µ–∑–ª—ã:** –•–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∞—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è.\n‚Ä¢ **–ö—É–±–∫–∏:** –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è, –∑–∞–±–æ—Ç–ª–∏–≤–∞—è.\n‚Ä¢ **–ú–µ—á–∏:** –£–º–Ω–∞—è, —Ö–æ–ª–æ–¥–Ω–∞—è, –≤–¥–æ–≤–∞.\n‚Ä¢ **–ü–µ–Ω—Ç–∞–∫–ª–∏:** –•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–∞—è, –±–æ–≥–∞—Ç–∞—è.",
            "üß© **–£—Ä–æ–∫ 16: –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ '–°–µ–º—å—è'**\n\n–†–∞–∑–ª–æ–∂–∏—Ç–µ –≤—Å–µ—Ö –¥–∞–º. –ö–∞–∫–∞—è –∏–∑ –Ω–∏—Ö –±–æ–ª—å—à–µ –ø–æ—Ö–æ–∂–∞ –Ω–∞ –≤–∞—à—É –º–∞—Ç—å? –ù–∞ –ø–æ–¥—Ä—É–≥—É? –ù–∞ –≤–∞—Å?"
        ]
    },
    "major_1": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã I (–£—Ä–æ–∫–∏ 17-20)",
        "lessons": [
            "0Ô∏è‚É£ **–£—Ä–æ–∫ 17: –®—É—Ç –∏ –ú–∞–≥**\n\n‚Ä¢ **0 –®—É—Ç:** –°–≤–æ–±–æ–¥–∞, —Ä–∏—Å–∫, –Ω–∞—á–∞–ª–æ —Å –Ω—É–ª—è. '–î—É—Ä–∞–∫' –∏–ª–∏ –≥–µ–Ω–∏–π.\n‚Ä¢ **I –ú–∞–≥:** –í–æ–ª—è, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, '–Ø –º–æ–≥—É'. –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –≤ —Ä—É–∫–∞—Ö.",
            "2Ô∏è‚É£ **–£—Ä–æ–∫ 18: –ñ—Ä–∏—Ü–∞ –∏ –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞**\n\n‚Ä¢ **II –ñ—Ä–∏—Ü–∞:** –¢–∞–π–Ω–∞, –∏–Ω—Ç—É–∏—Ü–∏—è, –ø–∞—Å—Å–∏–≤–Ω–æ—Å—Ç—å. –ó–Ω–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏.\n‚Ä¢ **III –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞:** –ü–ª–æ–¥–æ—Ä–æ–¥–∏–µ, –º–∞—Ç—å, –ø—Ä–∏—Ä–æ–¥–∞, —Ä–æ—Å—Ç.",
            "4Ô∏è‚É£ **–£—Ä–æ–∫ 19: –ò–º–ø–µ—Ä–∞—Ç–æ—Ä –∏ –ò–µ—Ä–æ—Ñ–∞–Ω—Ç**\n\n‚Ä¢ **IV –ò–º–ø–µ—Ä–∞—Ç–æ—Ä:** –í–ª–∞—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ—Ç–µ—Ü, –∑–∞–∫–æ–Ω.\n‚Ä¢ **V –ò–µ—Ä–æ—Ñ–∞–Ω—Ç:** –¢—Ä–∞–¥–∏—Ü–∏–∏, –±—Ä–∞–∫, —É—á–∏—Ç–µ–ª—å, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å.",
            "üÉè **–£—Ä–æ–∫ 20: –ü—Ä–∞–∫—Ç–∏–∫–∞ '–ê—Ä—Ö–µ—Ç–∏–ø—ã'**\n\n–ö–∞–∫–æ–π –ê—Ä–∫–∞–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—à —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∂–∏–∑–Ω–∏? –í—ã—Ç—è–Ω–∏—Ç–µ –∫–∞—Ä—Ç—É."
        ]
    },
    "major_2": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã II (–£—Ä–æ–∫–∏ 21-24)",
        "lessons": [
            "6Ô∏è‚É£ **–£—Ä–æ–∫ 21: –í–ª—é–±–ª–µ–Ω–Ω—ã–µ –∏ –ö–æ–ª–µ—Å–Ω–∏—Ü–∞**\n\n‚Ä¢ **VI –í–ª—é–±–ª–µ–Ω–Ω—ã–µ:** –í—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–µ–º, —Å–æ—é–∑, –∏—Å–∫—É—à–µ–Ω–∏–µ.\n‚Ä¢ **VII –ö–æ–ª–µ—Å–Ω–∏—Ü–∞:** –ü—Ä–æ—Ä—ã–≤, –ø–æ–±–µ–¥–∞ –≤–æ–ª–µ–π, –∫–æ–Ω—Ç—Ä–æ–ª—å —ç–º–æ—Ü–∏–π.",
            "8Ô∏è‚É£ **–£—Ä–æ–∫ 22: –°–∏–ª–∞ –∏ –û—Ç—à–µ–ª—å–Ω–∏–∫**\n\n‚Ä¢ **VIII –°–∏–ª–∞:** –ú—è–≥–∫–∞—è —Å–∏–ª–∞, —É–∫—Ä–æ—â–µ–Ω–∏–µ –∑–≤–µ—Ä—è (—Å—Ç—Ä–∞—Å—Ç–µ–π).\n‚Ä¢ **IX –û—Ç—à–µ–ª—å–Ω–∏–∫:** –ü–æ–∏—Å–∫ –º—É–¥—Ä–æ—Å—Ç–∏, —É–µ–¥–∏–Ω–µ–Ω–∏–µ, —Ñ–æ–Ω–∞—Ä—å –≤–æ —Ç—å–º–µ.",
            "üîü **–£—Ä–æ–∫ 23: –ö–æ–ª–µ—Å–æ –∏ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å**\n\n‚Ä¢ **X –ö–æ–ª–µ—Å–æ:** –°—É–¥—å–±–∞, —É–¥–∞—á–∞/–Ω–µ—É–¥–∞—á–∞, —Ü–∏–∫–ª–∏—á–Ω–æ—Å—Ç—å.\n‚Ä¢ **XI –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å:** –ö–∞—Ä–º–∞, –∑–∞–∫–æ–Ω, —á–µ—Å—Ç–Ω–æ—Å—Ç—å, —Ä–∞—Å–ø–ª–∞—Ç–∞.",
            "üÉè **–£—Ä–æ–∫ 24: –ü—Ä–∞–∫—Ç–∏–∫–∞**\n\n–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç—É '–°–∏–ª–∞'. –ì–¥–µ –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—è–≤–∏—Ç—å —Ç–µ—Ä–ø–µ–Ω–∏–µ?"
        ]
    },
    "major_3": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã III (–£—Ä–æ–∫–∏ 25-28)",
        "lessons": [
            "1Ô∏è‚É£2Ô∏è‚É£ **–£—Ä–æ–∫ 25: –ü–æ–≤–µ—à–µ–Ω–Ω—ã–π –∏ –°–º–µ—Ä—Ç—å**\n\n‚Ä¢ **XII –ü–æ–≤–µ—à–µ–Ω–Ω—ã–π:** –ñ–µ—Ä—Ç–≤–∞ —Ä–∞–¥–∏ —Ü–µ–ª–∏, –ø–∞—É–∑–∞, –∏–Ω–æ–π –≤–∑–≥–ª—è–¥.\n‚Ä¢ **XIII –°–º–µ—Ä—Ç—å:** –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ–Ω–µ—Ü —Å—Ç–∞—Ä–æ–≥–æ (–Ω–µ —Ñ–∏–∑. —Å–º–µ—Ä—Ç—å).",
            "1Ô∏è‚É£4Ô∏è‚É£ **–£—Ä–æ–∫ 26: –£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –î—å—è–≤–æ–ª**\n\n‚Ä¢ **XIV –£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:** –ê–ª—Ö–∏–º–∏—è, –±–∞–ª–∞–Ω—Å, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ, –≤—Ä–µ–º—è.\n‚Ä¢ **XV –î—å—è–≤–æ–ª:** –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –º–∞—Ç–µ—Ä–∏—è, —Å—Ç—Ä–∞—Ö, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è.",
            "1Ô∏è‚É£6Ô∏è‚É£ **–£—Ä–æ–∫ 27: –ë–∞—à–Ω—è –∏ –ó–≤–µ–∑–¥–∞**\n\n‚Ä¢ **XVI –ë–∞—à–Ω—è:** –ö—Ä–∞—Ö –∏–ª–ª—é–∑–∏–π, –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ.\n‚Ä¢ **XVII –ó–≤–µ–∑–¥–∞:** –ù–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, –ø—É—Ç—å –ø–æ—Å–ª–µ –±—É—Ä–∏.",
            "üÉè **–£—Ä–æ–∫ 28: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ö–æ–≤**\n\n–í—ã—Ç—è–Ω–∏—Ç–µ –∫–∞—Ä—Ç—É –Ω–∞ –≤–æ–ø—Ä–æ—Å: '–ß–µ–≥–æ —è –±–æ—é—Å—å?'. –¢—Ä–∞–∫—Ç—É–π—Ç–µ —á–µ—Ä–µ–∑ –ê—Ä–∫–∞–Ω—ã."
        ]
    },
    "major_4": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã IV (–£—Ä–æ–∫–∏ 29-30)",
        "lessons": [
            "1Ô∏è‚É£8Ô∏è‚É£ **–£—Ä–æ–∫ 29: –õ—É–Ω–∞ –∏ –°–æ–ª–Ω—Ü–µ**\n\n‚Ä¢ **XVIII –õ—É–Ω–∞:** –°—Ç—Ä–∞—Ö–∏, –∏–ª–ª—é–∑–∏–∏, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, –æ–±–º–∞–Ω.\n‚Ä¢ **XIX –°–æ–ª–Ω—Ü–µ:** –Ø—Å–Ω–æ—Å—Ç—å, —Å—á–∞—Å—Ç—å–µ, —É—Å–ø–µ—Ö, —ç–≥–æ.",
            "2Ô∏è‚É£0Ô∏è‚É£ **–£—Ä–æ–∫ 30: –°—É–¥ –∏ –ú–∏—Ä**\n\n‚Ä¢ **XX –°—É–¥:** –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –ø—Ä–∏–∑—ã–≤, –∏—Ç–æ–≥ –ø—Ä–æ—à–ª–æ–≥–æ.\n‚Ä¢ **XXI –ú–∏—Ä:** –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—É—Ç–∏, –≥–∞—Ä–º–æ–Ω–∏—è, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å."
        ]
    },
    "spreads_basic": {
        "title": "üÉè –ü—Ä–æ—Å—Ç—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã (–£—Ä–æ–∫–∏ 31-40)",
        "lessons": [
            "3Ô∏è‚É£ **–£—Ä–æ–∫ 31: –¢—Ä–∏ –∫–∞—Ä—Ç—ã**\n\n–°—Ö–µ–º—ã: [–ü—Ä–æ—à–ª–æ–µ - –ù–∞—Å—Ç. - –ë—É–¥—É—â–µ–µ] –∏–ª–∏ [–°–∏—Ç—É–∞—Ü–∏—è - –°–æ–≤–µ—Ç - –ò—Ç–æ–≥]. –°–∞–º—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥.",
            "‚ùå **–£—Ä–æ–∫ 32: –ö—Ä–µ—Å—Ç (4 –∫–∞—Ä—Ç—ã)**\n\n1. –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.\n2. –ß–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å.\n3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å.\n4. –†–µ–∑—É–ª—å—Ç–∞—Ç.",
            "üí° **–£—Ä–æ–∫ 33: –í—ã–±–æ—Ä (2 –ø—É—Ç–∏)**\n\n1. –°–∏—Ç—É–∞—Ü–∏—è.\n2-3-4. –ü—É—Ç—å –ê (—á—Ç–æ –±—É–¥–µ—Ç).\n5-6-7. –ü—É—Ç—å –ë (—á—Ç–æ –±—É–¥–µ—Ç).",
            "üõ†Ô∏è **–£—Ä–æ–∫ 34-35: –ü—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞ –±—ã—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö**\n\n'–ü–æ–∫—É–ø–∞—Ç—å –ª–∏ –º–∞—à–∏–Ω—É?', '–ü–æ–∑–≤–æ–Ω–∏—Ç –ª–∏ –æ–Ω?'. –î–µ–ª–∞–π—Ç–µ –ø–æ 3 —Ä–∞—Å–∫–ª–∞–¥–∞ –≤ –¥–µ–Ω—å.",
            "üìù **–£—Ä–æ–∫–∏ 36-40: –î–Ω–µ–≤–Ω–∏–∫**\n\n–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ä–∞—Å–∫–ª–∞–¥—ã. –ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, –∫–∞–∫ –æ–Ω–∏ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏—Å—å. –≠—Ç–æ –ª—É—á—à–∞—è —É—á–µ–±–∞."
        ]
    },
    "spreads_advanced": {
        "title": "üîÆ –°–ª–æ–∂–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã (–£—Ä–æ–∫–∏ 41-45)",
        "lessons": [
            "üçÄ **–£—Ä–æ–∫ 41: –ö–µ–ª—å—Ç—Å–∫–∏–π –ö—Ä–µ—Å—Ç (10 –∫–∞—Ä—Ç)**\n\n–ö–ª–∞—Å—Å–∏–∫–∞. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª—É–±–∏–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –≤–ª–∏—è–Ω–∏–µ –∏–∑–≤–Ω–µ, —Å—Ç—Ä–∞—Ö–∏ –∏ –∏—Ç–æ–≥. (–°—Ö–µ–º—É —Å–º. –≤ –≥—É–≥–ª–µ).",
            "‚ù§Ô∏è **–£—Ä–æ–∫ 42: –í–æ–∫–∑–∞–ª –¥–ª—è –¥–≤–æ–∏—Ö (7 –∫–∞—Ä—Ç)**\n\n–ê–Ω–∞–ª–∏–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏–π: –º—ã—Å–ª–∏, —á—É–≤—Å—Ç–≤–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è –æ–±–æ–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ + –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞.",
            "üóìÔ∏è **–£—Ä–æ–∫ 43: –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≥–æ–¥ (12 –¥–æ–º–æ–≤)**\n\n12 –∫–∞—Ä—Ç –ø–æ –∫—Ä—É–≥—É. –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —Å—Ñ–µ—Ä–∞ –∂–∏–∑–Ω–∏ (–∏–ª–∏ –º–µ—Å—è—Ü).",
            "üß† **–£—Ä–æ–∫–∏ 44-45: –ü—Ä–∞–∫—Ç–∏–∫–∞**\n\n–°–¥–µ–ª–∞–π—Ç–µ '–ö–µ–ª—å—Ç—Å–∫–∏–π –ö—Ä–µ—Å—Ç' –¥—Ä—É–≥—É. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å, —á–∏—Ç–∞–π—Ç–µ –∫–∞—Ä—Ç—ã –ø–æ–ø–∞—Ä–Ω–æ."
        ]
    },
    "final": {
        "title": "üéì –§–∏–Ω–∞–ª (–£—Ä–æ–∫–∏ 46-50)",
        "lessons": [
            "üß© **–£—Ä–æ–∫ 46: –°–∏–Ω—Ç–µ–∑**\n\n–£—á–∏—Ç–µ—Å—å –≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç–∏–Ω—É —Ü–µ–ª–∏–∫–æ–º. –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ú–µ—á–µ–π ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç. –ú–Ω–æ–≥–æ –°—Ç–∞—Ä—à–∏—Ö –ê—Ä–∫–∞–Ω–æ–≤ ‚Äî —Å—É–¥—å–±–æ–Ω–æ—Å–Ω—ã–π –º–æ–º–µ–Ω—Ç.",
            "üßò **–£—Ä–æ–∫ 47: –ò–Ω—Ç—É–∏—Ü–∏—è**\n\n–ò–Ω–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞ –∑–Ω–∞—á–∏—Ç –Ω–µ —Ç–æ, —á—Ç–æ –≤ –∫–Ω–∏–≥–µ. –î–æ–≤–µ—Ä—è–π—Ç–µ –ø–µ—Ä–≤–æ–º—É –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—é.",
            "üö´ **–£—Ä–æ–∫ 48: –≠—Ç–∏–∫–∞ —Ç–∞—Ä–æ–ª–æ–≥–∞**\n\n–ù–µ –≥–∞–¥–∞—Ç—å –Ω–∞ —Å–º–µ—Ä—Ç—å/–∑–¥–æ—Ä–æ–≤—å–µ (–µ—Å–ª–∏ –Ω–µ –≤—Ä–∞—á). –ù–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ–≥–∞—Ç–∏–≤ ('—Ç—ã —É–º—Ä–µ—à—å'), –∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å ('–±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω').",
            "üìà **–£—Ä–æ–∫ 49: –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è**\n\n–ö–∞–∫–∏–µ –∫–æ–ª–æ–¥—ã –µ—â–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã? –¢–∞—Ä–æ –¢–æ—Ç–∞? –ú–∞–Ω–∞—Ä–∞? –ò–∑—É—á–∞–π—Ç–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—é –∏ –∫–∞–±–±–∞–ª—É.",
            "üéâ **–£—Ä–æ–∫ 50: –í—ã–ø—É—Å–∫–Ω–æ–π!**\n\n–í—ã –ø—Ä–æ—à–ª–∏ 50 —á–∞—Å–æ–≤ —Ç–µ–æ—Ä–∏–∏. –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø—Ä–∞–∫—Ç–∏–∫–∞. –£–¥–∞—á–∏, –ú–∞–≥! üåü"
        ]
    }
}

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è ---
class TaroStates(StatesGroup):
    menu = State()

# --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
def get_main_menu():
    builder = InlineKeyboardBuilder()
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
    buttons = [
        ("üë∂ –í–≤–µ–¥–µ–Ω–∏–µ", "module_intro"),
        ("ü§¥ –ü—Ä–∏–¥–≤–æ—Ä–Ω—ã–µ", "module_minor_courts"),
        ("üî¢ –ß–∏—Å–ª–æ–≤—ã–µ", "module_minor_pips"),
        ("üëë –ö–æ—Ä–æ–ª–µ–≤—ã", "module_royals"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 1", "module_major_1"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 2", "module_major_2"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 3", "module_major_3"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 4", "module_major_4"),
        ("üÉè –†–∞—Å–∫–ª–∞–¥—ã 1", "module_spreads_basic"),
        ("üîÆ –†–∞—Å–∫–ª–∞–¥—ã 2", "module_spreads_advanced"),
        ("üéì –§–∏–Ω–∞–ª", "module_final"),
    ]
    for text, callback in buttons:
        builder.button(text=text, callback_data=callback)
    builder.adjust(2) 
    return builder.as_markup()

def get_lesson_nav(module_key, lesson_idx, total):
    builder = InlineKeyboardBuilder()
    # –ö–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥/–í–ø–µ—Ä–µ–¥
    if lesson_idx > 0:
        builder.button(text="‚¨ÖÔ∏è", callback_data=f"nav_{module_key}_{lesson_idx-1}")
    if lesson_idx < total - 1:
        builder.button(text="‚û°Ô∏è", callback_data=f"nav_{module_key}_{lesson_idx+1}")
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    builder.button(text="üîù –ú–µ–Ω—é", callback_data="taro_menu")
    
    # –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: [–ù–∞–∑–∞–¥, –í–ø–µ—Ä–µ–¥] (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–∞) –∏–ª–∏ [–û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞], –∑–∞—Ç–µ–º [–ú–µ–Ω—é]
    if lesson_idx > 0 and lesson_idx < total - 1:
        builder.adjust(2, 1)
    else:
        builder.adjust(1, 1) # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–µ–ª–∫–∞
        
    return builder.as_markup()

# --- –•–µ–Ω–¥–ª–µ—Ä—ã ---

@router.message(Command("taro"))
async def start_taro(message: types.Message, state: FSMContext):
    await message.answer(
        "üîÆ **–®–∫–æ–ª–∞ –¢–∞—Ä–æ**\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –æ–±—É—á–µ–Ω–∏—è (50 —á–∞—Å–æ–≤ –ø—Ä–∞–∫—Ç–∏–∫–∏):",
        reply_markup=get_main_menu(),
        parse_mode="Markdown"
    )

@router.callback_query(F.data == "taro_menu")
async def back_to_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        "üîÆ **–®–∫–æ–ª–∞ –¢–∞—Ä–æ**\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        reply_markup=get_main_menu(),
        parse_mode="Markdown"
    )

@router.callback_query(F.data.startswith("module_"))
async def open_module(callback: types.CallbackQuery):
    module_key = callback.data.split("_", 1)[1] # –ë–µ—Ä–µ–º –≤—Å—ë –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ module_
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫ (0)
    await show_lesson(callback, module_key, 0)

@router.callback_query(F.data.startswith("nav_"))
async def navigate_lesson(callback: types.CallbackQuery):
    # nav_intro_1 -> intro, 1
    # nav_minor_courts_2 -> minor_courts, 2
    try:
        _, module_key_raw, idx_raw = callback.data.split("_", 2)
        # –ï—Å–ª–∏ –≤ –∫–ª—é—á–µ –º–æ–¥—É–ª—è –µ—Å—Ç—å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è, split –º–æ–∂–µ—Ç —Ä–∞–∑–±–∏—Ç—å –Ω–µ —Ç–∞–∫.
        # –ü–æ—ç—Ç–æ–º—É —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º rsplit, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ nav_MOD_IDX –Ω–∞–¥–µ–∂–Ω–µ–µ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å.
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
        parts = callback.data.split("_")
        idx = int(parts[-1])
        module_key = "_".join(parts[1:-1]) # –°–æ–±–∏—Ä–∞–µ–º –∏–º—è –º–æ–¥—É–ª—è –æ–±—Ä–∞—Ç–Ω–æ
        
        await show_lesson(callback, module_key, idx)
    except Exception as e:
        await callback.answer(f"–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {e}")

async def show_lesson(callback: types.CallbackQuery, module_key, idx):
    data = COURSE_DATA.get(module_key)
    if not data: 
        return await callback.answer("–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
    
    lessons = data["lessons"]
    total = len(lessons)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    text = f"{data['title']} ({idx+1}/{total})\n\n{lessons[idx]}"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º try-except –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (Telegram —Ä—É–≥–∞–µ—Ç—Å—è)
    try:
        await callback.message.edit_text(
            text,
            reply_markup=get_lesson_nav(module_key, idx, total),
            parse_mode="Markdown",
            disable_web_page_preview=True
        )
    except Exception:
        await callback.answer() # –ü—Ä–æ—Å—Ç–æ –≥–∞—Å–∏–º —á–∞—Å–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏

def setup():
    return router
